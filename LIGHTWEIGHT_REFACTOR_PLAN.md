# 轻量化架构重构工作计划

## 项目概述

根据GitHub Issue #3的要求，本项目需要进行轻量化重构，目标是：
- 代码量从2160行减少到500行（减少77%）
- 响应时间从35秒降低到2秒（提升94%）
- 失败率从15%降低到2%（降低87%）
- 移除缓存架构、监控系统、复杂中间件
- 专注核心功能：简单透明的API代理

## 阶段一：核心重构（第1周）

### 1. 环境准备
- [x] 创建TodoList
- [ ] 更新主分支到最新状态
- [ ] 创建功能分支 `lightweight-refactor`
- [ ] 设置独立工作目录

### 2. 代码分析
- [ ] 分析当前代码复杂度
- [ ] 识别性能瓶颈
- [ ] 确定核心功能保留范围
- [ ] 制定简化策略

### 3. 轻量级转换器
- [ ] 重写 `converter_class.py`
  - 保留基本消息转换
  - 保留简单工具调用支持
  - 移除重试逻辑和错误处理
  - 简化日志输出（仅ERROR级别）
- [ ] 测试转换功能完整性

### 4. 轻量级服务器
- [ ] 重写 `api_server.py`
  - 移除限流功能
  - 移除缓存系统
  - 移除监控和统计
  - 移除Web配置界面
  - 简化为纯代理功能
- [ ] 环境变量优先配置

### 5. 配置管理简化
- [ ] 简化 `config_manager.py`
  - 移除Web界面支持
  - 优先使用环境变量
  - 移除复杂配置验证
- [ ] 删除 `config.html`

### 6. 辅助文件清理
- [ ] 简化 `start_server.py`
- [ ] 更新项目文档
- [ ] 清理临时测试文件

### 7. 性能验证
- [ ] 执行性能对比测试
- [ ] 验证核心转换功能不受影响
- [ ] 确认达到目标性能指标

## 核心原则

1. **KISS原则** - 保持简单愚蠢
2. **单一职责** - 每个组件只做一件事
3. **透明代理** - 不修改、不缓存、不存储
4. **快速失败** - 错误立即返回，不重试
5. **极简日志** - 只记录ERROR级别

## 性能目标

- 响应时间：<2秒（当前35秒）
- 失败率：<2%（当前15%）
- 代码量：~500行（当前2160行）
- 内存占用：<50MB

## 保留功能

### 核心转换功能
- Anthropic消息格式 ↔ OpenAI消息格式
- 基本工具调用支持（tool_use ↔ tool_calls）
- 基本角色映射（user/assistant）

### 基础服务器功能
- HTTP API端点
- 请求转发
- 错误处理
- 环境变量配置

## 移除功能

### 复杂中间件
- 请求去重机制
- 重试逻辑
- 限流控制
- 缓存系统

### 监控和管理
- 性能监控
- 请求统计
- Web配置界面
- 日志轮转

### 高级功能
- 智能转换
- 错误恢复
- 健康检查
- 优雅关闭

## 测试策略

1. 功能测试 - 确保核心转换不受影响
2. 性能测试 - 对比重构前后性能
3. 压力测试 - 验证轻量化后的稳定性
4. 兼容性测试 - 确保Claude Code正常工作

## 风险控制

1. 功能回归 - 通过完整测试套件验证
2. 性能退化 - 建立性能基准对比
3. 兼容性问题 - 保留关键API格式
4. 维护困难 - 简化代码结构和文档