name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    name: AI Code Analysis

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get Changed Files
      id: changed_files
      run: |
        echo "Analyzing code changes..."

        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
        else
          BASE="${{ github.event.before }}"
          HEAD="${{ github.sha }}"
        fi

        CHANGED_FILES=$(git diff --name-only "$BASE" "$HEAD" | tr '\n' ' ')
        echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT

        echo "ðŸ“ Changed files: $CHANGED_FILES"

    - name: Direct GLM API Review
      run: |
        echo "ðŸ¤– Starting direct GLM API review..."

        FILES="${{ steps.changed_files.outputs.files }}"

        # æž„å»ºç®€å•çš„åˆ†æžæç¤º
        PROMPT="è¯·åˆ†æžä»¥ä¸‹æ–‡ä»¶å˜æ›´ï¼š$FILESã€‚è¯·æä¾›ä»£ç è´¨é‡è¯„ä¼°å’Œæ”¹è¿›å»ºè®®ï¼Œç”¨ä¸­æ–‡ç®€æ´å›žå¤ã€‚"

        echo "ðŸ“¤ Calling GLM API directly..."

        # ç›´æŽ¥è°ƒç”¨ GLM API (ä½¿ç”¨ä½ é…ç½®çš„è¿œç¨‹æœåŠ¡)
        GLM_RESPONSE=$(curl -s -X POST "https://apis.iflow.cn/v1/chat/completions" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.UPSTREAM_API_KEY }}" \
          -d '{
            "model": "glm-4.6",
            "max_tokens": 800,
            "temperature": 0.3,
            "messages": [
              {
                "role": "user",
                "content": "'"$PROMPT"'"
              }
            ]
          }')

        echo "ðŸ“¥ GLM API Response:"
        echo "$GLM_RESPONSE"

        # è§£æžå“åº”
        if command -v jq &> /dev/null; then
          CONTENT=$(echo "$GLM_RESPONSE" | jq -r '.choices[0].message.content' 2>/dev/null || echo "è§£æžå¤±è´¥")
          echo "ðŸ¤– AI åˆ†æžç»“æžœï¼š"
          echo "$CONTENT"
        else
          echo "$GLM_RESPONSE"
        fi

    - name: Summary Report
      run: |
        echo "## ðŸŽ¯ ç›´æŽ¥ API ä»£ç å®¡æŸ¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š åˆ†æžç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ç›´æŽ¥è°ƒç”¨ GLM API" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” å·²åˆ†æžæ–‡ä»¶ï¼š${{ steps.changed_files.outputs.files }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ¤– ä½¿ç”¨ GLM-4.6 æ¨¡åž‹" >> $GITHUB_STEP_SUMMARY
        echo "- âš¡ æ— éœ€æœ¬åœ°æœåŠ¡" >> $GITHUB_STEP_SUMMARY