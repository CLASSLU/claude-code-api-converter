name: Debug Test Workflow

on:
  push:
    branches: [master]

jobs:
  debug-test:
    runs-on: ubuntu-latest
    name: è°ƒè¯•æµ‹è¯•

    steps:
    - name: åˆå§‹åŒ–
      run: echo "å¼€å§‹è°ƒè¯•æµ‹è¯•"

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: æµ‹è¯•åŸºæœ¬shellåŠŸèƒ½
      run: |
        echo "ğŸ”§ æµ‹è¯•åŸºæœ¬shellåŠŸèƒ½..."

        # æµ‹è¯•heredoc
        TEST_HEREDOC=$(cat <<'EOF'
è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•
å¤šè¡Œä¸­æ–‡å†…å®¹
å¸¦ç‰¹æ®Šå­—ç¬¦ï¼š@#$%^&*()
EOF
        )

        echo "âœ… Heredocæµ‹è¯•é€šè¿‡"
        echo "å†…å®¹é•¿åº¦: ${#TEST_HEREDOC}"
        echo "å†…å®¹: $TEST_HEREDOC"

    - name: æµ‹è¯•å˜é‡æ›¿æ¢
      run: |
        echo "ğŸ”„ æµ‹è¯•å˜é‡æ›¿æ¢..."

        FILES="test.txt debug.yml"
        PROMPT_TEMPLATE="è¯·åˆ†ææ–‡ä»¶ï¼šFILES_PLACEHOLDER"

        FINAL_PROMPT=$(echo "$PROMPT_TEMPLATE" | sed "s|FILES_PLACEHOLDER|$FILES|g")

        echo "âœ… å˜é‡æ›¿æ¢æµ‹è¯•é€šè¿‡"
        echo "åŸå§‹æ¨¡æ¿: $PROMPT_TEMPLATE"
        echo "æœ€ç»ˆç»“æœ: $FINAL_PROMPT"

    - name: æµ‹è¯•JSONè½¬ä¹‰
      run: |
        echo "ğŸ“‹ æµ‹è¯•JSONè½¬ä¹‰..."

        CHINESE_TEXT="è¯·åˆ†æè¿™ä¸ªä»£ç ï¼š\nfunction test() {\n  return 'ä½ å¥½ä¸–ç•Œ';\n}"

        if command -v jq &> /dev/null; then
            JSON_ESCAPED=$(echo "$CHINESE_TEXT" | jq -sR .)
            echo "âœ… JSONè½¬ä¹‰æµ‹è¯•é€šè¿‡"
            echo "åŸå§‹æ–‡æœ¬: $CHINESE_TEXT"
            echo "è½¬ä¹‰ç»“æœ: $JSON_ESCAPED"
        else
            echo "âŒ jqæœªå®‰è£…"
            exit 1
        fi

    - name: æµ‹è¯•APIè°ƒç”¨
      run: |
        echo "ğŸš€ æµ‹è¯•APIè°ƒç”¨..."

        # æ„å»ºç®€å•è¯·æ±‚
        SIMPLE_REQUEST='{
          "model": "glm-4.6",
          "max_tokens": 100,
          "messages": [{"role": "user", "content": "ç®€å•æµ‹è¯•"}]
        }'

        echo "è¯·æ±‚ä½“: $SIMPLE_REQUEST"

        # è°ƒç”¨API
        HTTP_CODE=$(curl \
          --silent \
          --show-error \
          --max-time 30 \
          --request POST \
          --url "https://apis.iflow.cn/v1/chat/completions" \
          --header "Content-Type: application/json; charset=utf-8" \
          --header "Authorization: Bearer ${{ secrets.UPSTREAM_API_KEY }}" \
          --data "$SIMPLE_REQUEST" \
          --output "test_response.json" \
          --write-out "%{http_code}")

        echo "ğŸ“Š HTTPçŠ¶æ€ç : $HTTP_CODE"

        if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… APIè°ƒç”¨æˆåŠŸ"
            if [ -f "test_response.json" ]; then
                echo "å“åº”å†…å®¹:"
                cat test_response.json | jq . || cat test_response.json
            fi
        else
            echo "âŒ APIè°ƒç”¨å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
            if [ -f "test_response.json" ]; then
                echo "é”™è¯¯å“åº”:"
                cat test_response.json
            fi
            exit 1
        fi

    - name: æµ‹è¯•å®Œæ•´æµç¨‹
      run: |
        echo "ğŸ”¬ æµ‹è¯•å®Œæ•´çš„å¤šæµç¨‹..."

        # 1. æ„å»ºå¤æ‚æç¤ºè¯
        COMPLEX_PROMPT=$(cat <<'EOF'
è¯·åˆ†æä»¥ä¸‹ä»£ç å˜æ›´ï¼š

## å˜æ›´æ–‡ä»¶
FILE_LIST_PLACEHOLDER

## ä»£ç å·®å¼‚
DIFF_PLACEHOLDER

è¯·ä»ä»¥ä¸‹ç»´åº¦åˆ†æï¼š
1. ä»£ç è´¨é‡
2. æ€§èƒ½å½±å“
3. å®‰å…¨é£é™©

è¯·ç”¨ä¸­æ–‡å›å¤ã€‚
EOF
        )

        # 2. æ›¿æ¢å ä½ç¬¦
        TEST_FILES="src/main.py docs/README.md"
        TEST_DIFF="æ–°å¢äº†ä¸€ä¸ªå‡½æ•°\nä¼˜åŒ–äº†æ€§èƒ½"

        FINAL_PROMPT=$(echo "$COMPLEX_PROMPT" | sed "s|FILE_LIST_PLACEHOLDER|$TEST_FILES|g")
        FINAL_PROMPT=$(echo "$FINAL_PROMPT" | sed "s|DIFF_PLACEHOLDER|$TEST_DIFF|g")

        # 3. JSONè½¬ä¹‰
        JSON_PROMPT=$(echo "$FINAL_PROMPT" | jq -sR .)

        # 4. æ„å»ºè¯·æ±‚ä½“
        FINAL_REQUEST=$(cat <<EOF
        {
          "model": "glm-4.6",
          "max_tokens": 500,
          "temperature": 0.3,
          "messages": [
            {
              "role": "user",
              "content": $JSON_PROMPT
            }
          ]
        }
        EOF
        )

        echo "ğŸ“ å®Œæ•´æµç¨‹æµ‹è¯•..."
        echo "æç¤ºè¯é•¿åº¦: ${#FINAL_PROMPT}"

        # 5. APIè°ƒç”¨
        HTTP_CODE=$(curl \
          --silent \
          --show-error \
          --max-time 30 \
          --request POST \
          --url "https://apis.iflow.cn/v1/chat/completions" \
          --header "Content-Type: application/json; charset=utf-8" \
          --header "Authorization: Bearer ${{ secrets.UPSTREAM_API_KEY }}" \
          --data "$FINAL_REQUEST" \
          --output "complex_response.json" \
          --write-out "%{http_code}")

        echo "ğŸ“Š å¤æ‚è¯·æ±‚çŠ¶æ€ç : $HTTP_CODE"

        if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸ"
            if [ -f "complex_response.json" ]; then
                ANALYSIS=$(jq -r '.choices[0].message.content // "è§£æå¤±è´¥"' complex_response.json)
                echo "AIåˆ†æç»“æœ:"
                echo "$ANALYSIS"
            fi
        else
            echo "âŒ å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥"
            if [ -f "complex_response.json" ]; then
                cat complex_response.json
            fi
            exit 1
        fi

    - name: æ”¶é›†è°ƒè¯•ä¿¡æ¯
      if: always()
      run: |
        echo "## ğŸ¯ è°ƒè¯•æµ‹è¯•æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ job.status }}" = "success" ]; then
            echo "### âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”§ ShellåŠŸèƒ½æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”„ å˜é‡æ›¿æ¢æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“‹ JSONè½¬ä¹‰æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸš€ APIè°ƒç”¨æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”¬ å®Œæ•´æµç¨‹æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        else
            echo "### âŒ æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ” éœ€è¦æ£€æŸ¥å¤±è´¥çš„æ­¥éª¤" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ—‚ï¸ æŸ¥çœ‹è¯¦ç»†æ—¥å¿—æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ä¸Šä¼ è°ƒè¯•æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: debug-files-${{ github.run_number }}
        path: |
          *.json
          *.log
        retention-days: 3