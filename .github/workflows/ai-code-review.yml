name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]
  push:
    branches: [main, master]

jobs:
  code-review:
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    runs-on: ubuntu-latest
    name: Code Analysis

    outputs:
      ai-review: ${{ steps.ai-review.outputs.review }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get Changed Files
      id: changed_files
      run: |
        echo "Analyzing code changes..."

        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
        else
          BASE="${{ github.event.before }}"
          HEAD="${{ github.sha }}"
        fi

        CHANGED_FILES=$(git diff --name-only "$BASE" "$HEAD" | tr '\n' ' ')
        echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT

        echo "ðŸ“ Changed files: $CHANGED_FILES"

    - name: AI Code Review
      id: ai-review
      run: |
        echo "ðŸ§  Starting comprehensive code review..."

        FILES="${{ steps.changed_files.outputs.files }}"

        # ä¸“ä¸šçš„ä»£ç å®¡æŸ¥æç¤ºè¯
        REVIEW_PROMPT="ä½œä¸ºä¸€åèµ„æ·±è½¯ä»¶å·¥ç¨‹å¸ˆå’Œä»£ç å®¡æŸ¥ä¸“å®¶ï¼Œè¯·å¯¹ä»¥ä¸‹ä»£ç å˜æ›´è¿›è¡Œå…¨é¢åˆ†æžï¼š

**å˜æ›´æ–‡ä»¶åˆ—è¡¨ï¼š** $FILES

**å®¡æŸ¥è¦æ±‚ï¼š**
1. **ä»£ç è´¨é‡è¯„ä¼°**ï¼šè¯„ä¼°ä»£ç ç»“æž„ã€å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§
2. **æœ€ä½³å®žè·µæ£€æŸ¥**ï¼šæ˜¯å¦ç¬¦åˆè¡Œä¸šæœ€ä½³å®žè·µå’Œç¼–ç è§„èŒƒ
3. **æ½œåœ¨é£Žé™©è¯†åˆ«**ï¼šå‘çŽ°å¯èƒ½çš„bugã€æ€§èƒ½ç“¶é¢ˆã€å®‰å…¨æ¼æ´ž
4. **æž¶æž„è®¾è®¡å»ºè®®**ï¼šå¯¹æ•´ä½“æž¶æž„å’Œè®¾è®¡æ¨¡å¼æå‡ºæ”¹è¿›æ„è§
5. **æµ‹è¯•è¦†ç›–åº¦**ï¼šè¯„ä¼°æµ‹è¯•éœ€æ±‚ï¼Œå»ºè®®æµ‹è¯•ç­–ç•¥

**è¾“å‡ºè¦æ±‚ï¼š**
- ä½¿ç”¨ä¸­æ–‡å›žå¤
- ç»“æž„æ¸…æ™°ï¼Œé‡ç‚¹çªå‡º
- æä¾›å…·ä½“çš„æ”¹è¿›å»ºè®®
- æ ‡æ³¨ä¼˜å…ˆçº§ï¼ˆé«˜/ä¸­/ä½Žï¼‰

è¯·è¿›è¡Œä¸“ä¸šçš„ä»£ç å®¡æŸ¥åˆ†æžã€‚"

        echo "ðŸ“¤ Sending code review request to AI..."

        AI_RESPONSE=$(curl -s -X POST "https://apis.iflow.cn/v1/chat/completions" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.UPSTREAM_API_KEY }}" \
          -d '{
            "model": "glm-4.6",
            "max_tokens": 2000,
            "temperature": 0.2,
            "messages": [
              {
                "role": "user",
                "content": "'"$REVIEW_PROMPT"'"
              }
            ]
          }')

        if command -v jq &> /dev/null; then
          CONTENT=$(echo "$AI_RESPONSE" | jq -r '.choices[0].message.content' 2>/dev/null || echo "AIå“åº”è§£æžå¤±è´¥")
        else
          CONTENT=$(echo "$AI_RESPONSE" | grep -o '"content":"[^"]*"' | cut -d'"' -f4 || echo "å“åº”æ ¼å¼å¼‚å¸¸")
        fi

        echo "review=$CONTENT" >> $GITHUB_OUTPUT

        echo "ðŸ“¥ AI Code Review Results:"
        echo "$CONTENT"

    - name: Create PR Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const review = `${{ steps.ai-review.outputs.review }}`;

          const comment = `## ðŸ¤– AI ä»£ç å®¡æŸ¥æŠ¥å‘Š

${review}

---

### ðŸ“Š å®¡æŸ¥ä¿¡æ¯
- **å®¡æŸ¥æ¨¡åž‹**: GLM-4.6
- **å®¡æŸ¥æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
- **å˜æ›´æ–‡ä»¶**: `${{ steps.changed_files.outputs.files }}`
- **å®¡æŸ¥æ–¹å¼**: é™æ€åˆ†æžï¼Œä¸å½±å“ä»£ç åˆå¹¶

> ðŸ“‹ *æ­¤æŠ¥å‘Šç”± AI è‡ªåŠ¨ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒã€‚è¯·ç»“åˆäººå·¥å®¡æŸ¥è¿›è¡Œæœ€ç»ˆåˆ¤æ–­ã€‚`;

          if (context.payload.pull_request) {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

    - name: Summary Report
      run: |
        echo "## ðŸŽ¯ ä»£ç å®¡æŸ¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š å®¡æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å®Œæˆä¸“ä¸šä»£ç è´¨é‡åˆ†æž" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” å·²åˆ†æžæ–‡ä»¶ï¼š${{ steps.changed_files.outputs.files }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ¤– ä½¿ç”¨ GLM-4.6 æ¨¡åž‹" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ PR è¯„è®ºå·²${{ github.event_name == 'pull_request' && 'æ·»åŠ ' || 'è·³è¿‡' }}" >> $GITHUB_STEP_SUMMARY

  issue-review:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    name: Issue Analysis

    steps:
    - name: Issue Review
      id: issue-review
      run: |
        echo "ðŸ” Analyzing issue: #${{ github.event.issue.number }}"

        ISSUE_TITLE="${{ github.event.issue.title }}"
        ISSUE_BODY="${{ github.event.issue.body }}"
        ISSUE_AUTHOR="${{ github.event.issue.user.login }}"

        # ä¸“ä¸šçš„Issueå®¡æŸ¥æç¤ºè¯
        ISSUE_PROMPT="ä½œä¸ºé¡¹ç›®ç»´æŠ¤è€…å’ŒæŠ€æœ¯é¡¾é—®ï¼Œè¯·å¯¹ä»¥ä¸‹ GitHub Issue è¿›è¡Œå…¨é¢è¯„ä¼°ï¼š

**Issue æ ‡é¢˜ï¼š** $ISSUE_TITLE
**Issue ä½œè€…ï¼š** $ISSUE_AUTHOR
**Issue å†…å®¹ï¼š** $ISSUE_BODY

**å®¡æŸ¥ç»´åº¦ï¼š**
1. **é—®é¢˜æ¸…æ™°åº¦**ï¼šé—®é¢˜æè¿°æ˜¯å¦å‡†ç¡®ã€å®Œæ•´ã€æ— æ­§ä¹‰
2. **æŠ€æœ¯å¯è¡Œæ€§**ï¼šå½“å‰æŠ€æœ¯æ ˆå’Œå·¥å…·æ˜¯å¦èƒ½è§£å†³æ­¤é—®é¢˜
3. **å®žçŽ°éš¾åº¦**ï¼šè¯„ä¼°å¼€å‘å¤æ‚åº¦ã€é¢„ä¼°å·¥ä½œé‡ï¼ˆé«˜ä¸­ä½Žï¼‰
4. **ä¼˜å…ˆçº§è¯„ä¼°**ï¼šåŸºäºŽä¸šåŠ¡ä»·å€¼å’Œç´§æ€¥ç¨‹åº¦ç»™å‡ºä¼˜å…ˆçº§å»ºè®®
5. **ä¾èµ–åˆ†æž**ï¼šè¯†åˆ«å¯èƒ½çš„æŠ€æœ¯ä¾èµ–ã€å¤–éƒ¨ä¾èµ–æˆ–å‰ç½®æ¡ä»¶
6. **é£Žé™©è¯„ä¼°**ï¼šæ½œåœ¨çš„æŠ€æœ¯é£Žé™©ã€æ—¶é—´é£Žé™©ã€èµ„æºé£Žé™©
7. **è§£å†³æ–¹æ¡ˆå»ºè®®**ï¼šæä¾›å…·ä½“çš„å®žçŽ°æ€è·¯æˆ–è§£å†³æ–¹æ¡ˆæ¡†æž¶

**è¾“å‡ºæ ¼å¼ï¼š**
- ä½¿ç”¨ä¸­æ–‡å›žå¤
- åˆ†æ®µæ¸…æ™°ï¼Œé€»è¾‘è¿žè´¯
- ç»™å‡ºæ˜Žç¡®çš„å»ºè®¾æ€§æ„è§

è¯·æä¾›ä¸“ä¸šçš„Issueåˆ†æžå’Œå»ºè®®ã€‚"

        echo "ðŸ“¤ Sending issue review request to AI..."

        AI_RESPONSE=$(curl -s -X POST "https://apis.iflow.cn/v1/chat/completions" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.UPSTREAM_API_KEY }}" \
          -d '{
            "model": "glm-4.6",
            "max_tokens": 1500,
            "temperature": 0.2,
            "messages": [
              {
                "role": "user",
                "content": "'"$ISSUE_PROMPT"'"
              }
            ]
          }')

        if command -v jq &> /dev/null; then
          CONTENT=$(echo "$AI_RESPONSE" | jq -r '.choices[0].message.content' 2>/dev/null || echo "AIå“åº”è§£æžå¤±è´¥")
        else
          CONTENT=$(echo "$AI_RESPONSE" | grep -o '"content":"[^"]*"' | cut -d'"' -f4 || echo "å“åº”æ ¼å¼å¼‚å¸¸")
        fi

        echo "ðŸ“¥ AI Issue Analysis Results:"
        echo "$CONTENT"

    - name: Create Issue Comment
      uses: actions/github-script@v7
      with:
        script: |
          const issueTitle = "${{ github.event.issue.title }}";
          const issueNumber = context.issue.number;

          // èŽ·å–AIåˆ†æžç»“æžœ
          const analysis = `
## ðŸ” Issue AI åˆ†æžæŠ¥å‘Š

${{ steps.issue-review.outputs.issue_review }}

---

### ðŸ“‹ åˆ†æžä¿¡æ¯
- **Issueæ ‡é¢˜**: ${issueTitle}
- **Issueç¼–å·**: #${issueNumber}
- **åˆ†æžå¸ˆ**: AI Assistant (GLM-4.6)
- **åˆ†æžæ—¶é—´**: ${new Date().toLocaleString('zh-CN')}

> ðŸ’¡ *æ­¤åˆ†æžç”± AI åŠ©æ‰‹æä¾›ï¼Œç»“åˆäººå·¥åˆ¤æ–­è¿›è¡Œå†³ç­–ã€‚*`;

          github.rest.issues.createComment({
            issue_number: issueNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: analysis
          });

    - name: Issue Summary
      run: |
        echo "## ðŸŽ¯ Issue åˆ†æžå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š åˆ†æžç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å®ŒæˆIssueå¯è¡Œæ€§åˆ†æž" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” åˆ†æžIssue #${{ github.event.issue.number }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ¤– ä½¿ç”¨ GLM-4.6 æ¨¡åž‹" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ’¬ åˆ†æžè¯„è®ºå·²æ·»åŠ åˆ°Issue" >> $GITHUB_STEP_SUMMARY