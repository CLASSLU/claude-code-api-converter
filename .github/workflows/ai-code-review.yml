name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]
  push:
    branches: [main, master]

jobs:
  code-review:
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    runs-on: ubuntu-latest
    name: Code Analysis

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get Changed Files
      id: changed_files
      run: |
        echo "Analyzing code changes..."

        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
        else
          BASE="${{ github.event.before }}"
          HEAD="${{ github.sha }}"
        fi

        CHANGED_FILES=$(git diff --name-only "$BASE" "$HEAD" | tr '\n' ' ')
        echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT

        echo "ğŸ“ Changed files: $CHANGED_FILES"

    - name: AI Code Review
      id: ai-review
      run: |
        echo "ğŸ§  Starting comprehensive code review..."

        FILES="${{ steps.changed_files.outputs.files }}"

        # ä¸“ä¸šçš„ä»£ç å®¡æŸ¥æç¤ºè¯
        REVIEW_PROMPT="ä½œä¸ºèµ„æ·±è½¯ä»¶å·¥ç¨‹ä¸“å®¶ï¼ŒåŸºäºå¤šå¹´ä¼ä¸šçº§é¡¹ç›®å¼€å‘å’Œä»£ç å®¡æŸ¥ç»éªŒï¼Œè¯·å¯¹æ­¤æ¬¡ä»£ç å˜æ›´è¿›è¡Œæ·±åº¦æŠ€æœ¯è¯„å®¡ï¼š

**å˜æ›´æ¦‚è§ˆ**
- æ–‡ä»¶åˆ—è¡¨ï¼š$FILES
- å®¡æŸ¥ç›®æ ‡ï¼šç¡®ä¿ä»£ç è´¨é‡ã€ç³»ç»Ÿç¨³å®šæ€§å’Œå›¢é˜Ÿåä½œæ•ˆç‡

**æ ¸å¿ƒå®¡æŸ¥ç»´åº¦**

**ğŸ—ï¸ æ¶æ„ä¸è®¾è®¡è´¨é‡**
- è®¾è®¡æ¨¡å¼åº”ç”¨æ˜¯å¦æ°å½“ï¼Œæ˜¯å¦ç¬¦åˆSOLIDåŸåˆ™
- æ¨¡å—è€¦åˆåº¦å’Œå†…èšæ€§åˆ†æ
- æ¥å£è®¾è®¡çš„åˆç†æ€§è¯„ä¼°
- é•¿æœŸå¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§è€ƒé‡

**âš¡ æ€§èƒ½ä¸æ•ˆç‡**
- ç®—æ³•å¤æ‚åº¦å’Œæ—¶é—´/ç©ºé—´æ•ˆç‡åˆ†æ
- èµ„æºä½¿ç”¨æ¨¡å¼è¯„ä¼°ï¼ˆå†…å­˜ã€CPUã€I/Oï¼‰
- æ½œåœ¨æ€§èƒ½ç“¶é¢ˆè¯†åˆ«å’Œä¼˜åŒ–å»ºè®®
- ç¼“å­˜ç­–ç•¥å’Œæ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

**ğŸ”’ å®‰å…¨æ€§ä¸å¥å£®æ€§**
- è¾“å…¥éªŒè¯å’Œæ•°æ®æ ¡éªŒå®Œæ•´æ€§
- å¼‚å¸¸å¤„ç†æœºåˆ¶çš„å¥å£®æ€§
- å®‰å…¨æ¼æ´æ£€æŸ¥ï¼ˆSQLæ³¨å…¥ã€XSSã€æƒé™ç»•è¿‡ç­‰ï¼‰
- æ•æ„Ÿæ•°æ®å¤„ç†çš„åˆè§„æ€§

**ğŸ› ï¸ ä»£ç è§„èŒƒä¸å·¥ç¨‹å®è·µ**
- ç¼–ç é£æ ¼ç»Ÿä¸€æ€§å’Œå¯è¯»æ€§
- ä»£ç å¤ç”¨æ€§å’ŒDRYåŸåˆ™éµå¾ª
- æ—¥å¿—è®°å½•å’Œç›‘æ§é›†æˆ
- é”™è¯¯å¤„ç†å’Œè°ƒè¯•å‹å¥½æ€§

**ğŸ“‹ æµ‹è¯•ç­–ç•¥ä¸è´¨é‡ä¿è¯**
- å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•è¦†ç›–åº¦å»ºè®®
- è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸åœºæ™¯æµ‹è¯•è¦ç‚¹
- æ€§èƒ½æµ‹è¯•å’Œå®‰å…¨æµ‹è¯•çš„å¿…è¦æ€§
- ä»£ç å®¡æŸ¥æµç¨‹æ”¹è¿›å»ºè®®

**ğŸ“Œ è¾“å‡ºæ ¼å¼è¦æ±‚**
- ç»“æ„åŒ–åˆ†æï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºé—®é¢˜
- æä¾›å¯æ“ä½œçš„å…·ä½“æ”¹è¿›æ–¹æ¡ˆ
- æ ‡æ³¨å½±å“èŒƒå›´å’Œä¿®å¤å¤æ‚åº¦
- ç»™å‡ºæœ€ä½³å®è·µå‚è€ƒç¤ºä¾‹

è¯·è¿›è¡Œå…¨é¢çš„æŠ€æœ¯è¯„ä¼°å¹¶æä¾›å»ºè®¾æ€§çš„æ”¹è¿›æŒ‡å¯¼ã€‚"

        echo "ğŸ“¤ Sending code review request to AI..."

        AI_RESPONSE=$(curl -s -X POST "https://apis.iflow.cn/v1/chat/completions" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.UPSTREAM_API_KEY }}" \
          -d '{
            "model": "glm-4.6",
            "max_tokens": 2000,
            "temperature": 0.2,
            "messages": [
              {
                "role": "user",
                "content": "'"$REVIEW_PROMPT"'"
              }
            ]
          }')

        if command -v jq &> /dev/null; then
          CONTENT=$(echo "$AI_RESPONSE" | jq -r '.choices[0].message.content' 2>/dev/null || echo "AIå“åº”è§£æå¤±è´¥")
        else
          CONTENT=$(echo "$AI_RESPONSE" | grep -o '"content":"[^"]*"' | cut -d'"' -f4 || echo "å“åº”æ ¼å¼å¼‚å¸¸")
        fi

        echo "ğŸ“¥ AI Code Review Results:"
        echo "$CONTENT"

        # è®¾ç½®è¾“å‡ºå˜é‡ä¾›PRè¯„è®ºä½¿ç”¨
        echo "review<<EOF" >> $GITHUB_OUTPUT
        echo "$CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create PR Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const review = `${{ steps.ai-review.outputs.review }}`;

          const comment = `## ğŸ¤– AI ä»£ç å®¡æŸ¥æŠ¥å‘Š

${review}

---

### ğŸ“Š å®¡æŸ¥ä¿¡æ¯
- **å®¡æŸ¥æ¨¡å‹**: GLM-4.6
- **å®¡æŸ¥æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
- **å˜æ›´æ–‡ä»¶**: `${{ steps.changed_files.outputs.files }}`
- **å®¡æŸ¥æ–¹å¼**: é™æ€åˆ†æï¼Œä¸å½±å“ä»£ç åˆå¹¶

> ğŸ“‹ *æ­¤æŠ¥å‘Šç”± AI è‡ªåŠ¨ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒã€‚è¯·ç»“åˆäººå·¥å®¡æŸ¥è¿›è¡Œæœ€ç»ˆåˆ¤æ–­ã€‚`;

          if (context.payload.pull_request) {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

    - name: Summary Report
      run: |
        echo "## ğŸ¯ ä»£ç å®¡æŸ¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š å®¡æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å®Œæˆä¸“ä¸šä»£ç è´¨é‡åˆ†æ" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ” å·²åˆ†ææ–‡ä»¶ï¼š${{ steps.changed_files.outputs.files }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ¤– ä½¿ç”¨ GLM-4.6 æ¨¡å‹" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“ PR è¯„è®ºå·²${{ github.event_name == 'pull_request' && 'æ·»åŠ ' || 'è·³è¿‡' }}" >> $GITHUB_STEP_SUMMARY

  issue-review:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    name: Issue Analysis

    steps:
    - name: Issue Review
      id: issue-review
      run: |
        echo "ğŸ” Analyzing issue: #${{ github.event.issue.number }}"

        ISSUE_TITLE="${{ github.event.issue.title }}"
        ISSUE_BODY="${{ github.event.issue.body }}"
        ISSUE_AUTHOR="${{ github.event.issue.user.login }}"

        # ä¸“ä¸šçš„Issueå®¡æŸ¥æç¤ºè¯
        ISSUE_PROMPT="ä½œä¸ºèµ„æ·±æŠ€æœ¯æ€»ç›‘å’Œäº§å“æ¶æ„å¸ˆï¼ŒåŸºäºä¸°å¯Œçš„é¡¹ç›®ç®¡ç†å’Œéœ€æ±‚åˆ†æç»éªŒï¼Œè¯·å¯¹ä»¥ä¸‹GitHub Issueè¿›è¡Œæ·±åº¦å¯è¡Œæ€§è¯„ä¼°ï¼š

**IssueåŸºç¡€ä¿¡æ¯**
- æ ‡é¢˜ï¼š$ISSUE_TITLE
- å‘èµ·è€…ï¼š$ISSUE_AUTHOR
- è¯·æ±‚è¯¦æƒ…ï¼š$ISSUE_BODY

**ğŸ¯ éœ€æ±‚æ¸…æ™°åº¦ä¸å®Œæ•´æ€§åˆ†æ**
- é—®é¢˜é™ˆè¿°çš„å‡†ç¡®æ€§å’Œå…·ä½“ç¨‹åº¦è¯„ä¼°
- åŠŸèƒ½éœ€æ±‚è¾¹ç•Œæ˜¯å¦æ˜ç¡®ï¼Œæ˜¯å¦å­˜åœ¨äºŒä¹‰æ€§
- é¢„æœŸç»“æœå’ŒéªŒæ”¶æ ‡å‡†æ˜¯å¦æ¸…æ™°å®šä¹‰
- æ˜¯å¦éœ€è¦è¿›ä¸€æ­¥çš„éœ€æ±‚æ¾„æ¸…å’Œè¡¥å……ä¿¡æ¯

**ğŸ—ï¸ æŠ€æœ¯å¯è¡Œæ€§ä¸æ¶æ„é€‚é…æ€§**
- å½“å‰æŠ€æœ¯æ ˆå¯¹æ­¤éœ€æ±‚çš„æ”¯æŒèƒ½åŠ›è¯„ä¼°
- æ˜¯å¦éœ€è¦å¼•å…¥æ–°çš„æŠ€æœ¯ç»„ä»¶æˆ–ç¬¬ä¸‰æ–¹æœåŠ¡
- ä¸ç°æœ‰ç³»ç»Ÿæ¶æ„çš„å…¼å®¹æ€§åˆ†æ
- æŠ€æœ¯å€ºåŠ¡å½±å“å’Œç»´æŠ¤æˆæœ¬è€ƒé‡

**âš™ï¸ å®ç°å¤æ‚åº¦ä¸èµ„æºè¯„ä¼°**
- å¼€å‘å·¥ä½œé‡é¢„ä¼°ï¼ˆäººå¤©ï¼‰ï¼šå…·ä½“çš„æŠ€æœ¯éš¾ç‚¹å’Œè§£å†³æ–¹æ¡ˆè·¯å¾„
- ä¾èµ–å…³ç³»åˆ†æï¼šå¤–éƒ¨APIã€ç¬¬ä¸‰æ–¹æœåŠ¡ã€å›¢é˜Ÿåä½œéœ€æ±‚
- é£é™©è¯†åˆ«ï¼šæŠ€æœ¯é£é™©ã€è¿›åº¦é£é™©ã€èµ„æºé£é™©
- æµ‹è¯•ç­–ç•¥ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€ç«¯åˆ°ç«¯æµ‹è¯•çš„è¦†ç›–è§„åˆ’

**ğŸ“Š ä¸šåŠ¡ä»·å€¼ä¸ä¼˜å…ˆçº§æ’åº**
- ç”¨æˆ·ä»·å€¼è¯„ä¼°å’Œä¸šåŠ¡å½±å“ç¨‹åº¦
- ä¸äº§å“è·¯çº¿å›¾çš„å¥‘åˆåº¦åˆ†æ
- å¸‚åœºç«äº‰ä¼˜åŠ¿å’Œå·®å¼‚åŒ–ä»·å€¼
- ROIï¼ˆæŠ•èµ„å›æŠ¥ç‡ï¼‰åˆæ­¥è¯„ä¼°

**âš¡ è§£å†³æ–¹æ¡ˆä¸å®æ–½è·¯å¾„**
- æŠ€æœ¯æ¶æ„å»ºè®®å’Œè®¾è®¡æ–¹æ¡ˆæ¡†æ¶
- å…³é”®é‡Œç¨‹ç¢‘å’Œäº¤ä»˜ç‰©è§„åˆ’
- æ½œåœ¨çš„æ›¿ä»£æ–¹æ¡ˆå’ŒæŠ€æœ¯é€‰å‹å»ºè®®
- é•¿æœŸç»´æŠ¤å’Œè¿­ä»£ä¼˜åŒ–ç­–ç•¥

**ğŸ“‹ è¯„ä¼°ç»“è®ºä¸è¡ŒåŠ¨å»ºè®®**
- æ˜ç¡®çš„å¯è¡Œæ€§ç»“è®ºï¼ˆé«˜/ä¸­/ä½ä¼˜å…ˆçº§ï¼‰
- å…·ä½“çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨é¡¹
- å›¢é˜Ÿåä½œå»ºè®®å’Œæ—¶é—´å®‰æ’
- é£é™©ç¼“è§£æªæ–½å’Œåº”æ€¥é¢„æ¡ˆ

è¯·æä¾›ç»“æ„åŒ–çš„ä¸“ä¸šè¯„ä¼°æŠ¥å‘Šï¼ŒåŒ…å«æ˜ç¡®çš„å¯æ“ä½œå»ºè®®å’Œå†³ç­–ä¾æ®ã€‚"

        echo "ğŸ“¤ Sending issue review request to AI..."

        AI_RESPONSE=$(curl -s -X POST "https://apis.iflow.cn/v1/chat/completions" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.UPSTREAM_API_KEY }}" \
          -d '{
            "model": "glm-4.6",
            "max_tokens": 1500,
            "temperature": 0.2,
            "messages": [
              {
                "role": "user",
                "content": "'"$ISSUE_PROMPT"'"
              }
            ]
          }')

        if command -v jq &> /dev/null; then
          CONTENT=$(echo "$AI_RESPONSE" | jq -r '.choices[0].message.content' 2>/dev/null || echo "AIå“åº”è§£æå¤±è´¥")
        else
          CONTENT=$(echo "$AI_RESPONSE" | grep -o '"content":"[^"]*"' | cut -d'"' -f4 || echo "å“åº”æ ¼å¼å¼‚å¸¸")
        fi

        echo "ğŸ“¥ AI Issue Analysis Results:"
        echo "$CONTENT"

        # è®¾ç½®è¾“å‡ºå˜é‡ä¾›Issueè¯„è®ºä½¿ç”¨
        echo "issue_review<<EOF" >> $GITHUB_OUTPUT
        echo "$CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Issue Comment
      uses: actions/github-script@v7
      with:
        script: |
          const issueTitle = "${{ github.event.issue.title }}";
          const issueNumber = context.issue.number;

          // è·å–AIåˆ†æç»“æœ
          const analysis = `
## ğŸ” Issue AI åˆ†ææŠ¥å‘Š

${{ steps.issue-review.outputs.issue_review }}

---

### ğŸ“‹ åˆ†æä¿¡æ¯
- **Issueæ ‡é¢˜**: ${issueTitle}
- **Issueç¼–å·**: #${issueNumber}
- **åˆ†æå¸ˆ**: AI Assistant (GLM-4.6)
- **åˆ†ææ—¶é—´**: ${new Date().toLocaleString('zh-CN')}

> ğŸ’¡ *æ­¤åˆ†æç”± AI åŠ©æ‰‹æä¾›ï¼Œç»“åˆäººå·¥åˆ¤æ–­è¿›è¡Œå†³ç­–ã€‚*`;

          github.rest.issues.createComment({
            issue_number: issueNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: analysis
          });

    - name: Issue Summary
      run: |
        echo "## ğŸ¯ Issue åˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š åˆ†æç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å®ŒæˆIssueå¯è¡Œæ€§åˆ†æ" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ” åˆ†æIssue #${{ github.event.issue.number }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ¤– ä½¿ç”¨ GLM-4.6 æ¨¡å‹" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ’¬ åˆ†æè¯„è®ºå·²æ·»åŠ åˆ°Issue" >> $GITHUB_STEP_SUMMARY