name: AI Code Review with External Models

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    name: AI Code Analysis

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Test Converter Connection
      run: |
        echo "ğŸ”— Testing connection to converter service..."

        # å¥åº·æ£€æŸ¥
        HEALTH_RESPONSE=$(curl -s -w "%{http_code}" "https://blue-spoons-run.loca.lt/health")
        HTTP_CODE="${HEALTH_RESPONSE: -3}"
        BODY="${HEALTH_RESPONSE%???}"

        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… Converter service is healthy"
          echo "Response: $BODY"
        else
          echo "âŒ Converter service not accessible: HTTP $HTTP_CODE"
          exit 1
        fi

    - name: Check Available Models
      run: |
        echo "ğŸ¤– Checking available models..."

        MODELS_RESPONSE=$(curl -s "https://blue-spoons-run.loca.lt/v1/models")
        echo "Available models: $MODELS_RESPONSE"

    - name: Get Changed Files
      id: changed_files
      run: |
        echo "Analyzing code changes..."

        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
        else
          BASE="${{ github.event.before }}"
          HEAD="${{ github.sha }}"
        fi

        # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
        CHANGED_FILES=$(git diff --name-only "$BASE" "$HEAD" | tr '\n' ' ')
        echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT

        # è·å–å…·ä½“çš„ä»£ç å˜æ›´
        DIFF_CONTENT=$(git diff "$BASE" "$HEAD" --unified=3)
        echo "diff<<EOF" >> $GITHUB_OUTPUT
        echo "$DIFF_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        echo "ğŸ“ Changed files: $CHANGED_FILES"

    - name: AI Code Review
      run: |
        echo "ğŸ§  Starting AI code review..."

        # æ„å»ºåˆ†ææç¤º
        FILES="${{ steps.changed_files.outputs.files }}"
        DIFF="${{ steps.changed_files.outputs.diff }}"

        REVIEW_PROMPT="è¯·ä½œä¸ºä¸€ä½ç»éªŒä¸°å¯Œçš„ä»£ç å®¡æŸ¥è€…ï¼Œåˆ†æä»¥ä¸‹ä»£ç å˜æ›´ï¼š

å˜æ›´æ–‡ä»¶ï¼š$FILES

å…·ä½“å˜æ›´å†…å®¹ï¼š
$DIFF

è¯·æä¾›ï¼š
1. ä»£ç è´¨é‡è¯„ä¼°
2. æ½œåœ¨é—®é¢˜å’Œæ”¹è¿›å»ºè®®
3. æœ€ä½³å®è·µå»ºè®®
4. å®‰å…¨æ€§æ£€æŸ¥ï¼ˆå¦‚é€‚ç”¨ï¼‰

è¯·ç”¨ä¸­æ–‡å›å¤ï¼Œæ ¼å¼æ¸…æ™°ï¼Œé‡ç‚¹çªå‡ºã€‚"

        echo "ğŸ“¤ Sending review request to AI..."

        # è°ƒç”¨æˆ‘ä»¬çš„è½¬æ¢å™¨
        AI_RESPONSE=$(curl -s -X POST "https://blue-spoons-run.loca.lt/v1/messages" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.UPSTREAM_API_KEY }}" \
          -d "{
            \"model\": \"glm-4.6\",
            \"max_tokens\": 2000,
            \"temperature\": 0.3,
            \"messages\": [
              {
                \"role\": \"user\",
                \"content\": \"$REVIEW_PROMPT\"
              }
            ]
          }")

        echo "ğŸ“¥ AI Response:"
        echo "$AI_RESPONSE" | jq -r '.content[0].text' || echo "$AI_RESPONSE"

    - name: Create Review Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const response = require('./ai_review_response.json');
          const comment = `
## ğŸ¤– AI ä»£ç å®¡æŸ¥æŠ¥å‘Š

<details>
<summary>ğŸ“‹ å®Œæ•´åˆ†æç»“æœ</summary>

\`\`\`
${response}
\`\`\`

</details>

---
*æ­¤å®¡æŸ¥ç”± AI æ¨¡å‹é€šè¿‡è½¬æ¢å™¨æœåŠ¡ç”Ÿæˆ*
`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Summary Report
      run: |
        echo "## ğŸ¯ AI ä»£ç å®¡æŸ¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š åˆ†æç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… è½¬æ¢å™¨æœåŠ¡è¿æ¥æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ” å·²åˆ†æ ${{ steps.changed_files.outputs.files }} çš„å˜æ›´" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ¤– ä½¿ç”¨ GLM-4.6 æ¨¡å‹è¿›è¡Œæ™ºèƒ½åˆ†æ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— æœåŠ¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- è½¬æ¢å™¨åœ°å€: https://blue-spoons-run.loca.lt" >> $GITHUB_STEP_SUMMARY
        echo "- æ¨¡å‹: GLM-4.6" >> $GITHUB_STEP_SUMMARY
        echo "- å“åº”æ—¶é—´: $(curl -s -o /dev/null -w '%{time_total}' https://blue-spoons-run.loca.lt/health)s" >> $GITHUB_STEP_SUMMARY

  test-connection:
    runs-on: ubuntu-latest
    name: Connection Test

    steps:
    - name: Quick Health Check
      run: |
        echo "ğŸ” Quick health check..."
        response=$(curl -s "https://blue-spoons-run.loca.lt/health")
        echo "Health check response: $response"

        # æ£€æŸ¥æ˜¯å¦åŒ…å« expected status
        if echo "$response" | grep -q "healthy"; then
          echo "âœ… Service is healthy"
        else
          echo "âŒ Service may have issues"
          exit 1
        fi