name: Professional AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]
  push:
    branches: [main, master]

env:
  API_BASE_URL: "https://apis.iflow.cn/v1"
  DEFAULT_MODEL: "glm-4.6"

jobs:
  PRReview:
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    runs-on: ubuntu-latest
    name: PRä»£ç å®¡æŸ¥

    strategy:
      matrix:
        retry-count: [0]
      fail-fast: false

    steps:
    - name: ğŸš€ åˆå§‹åŒ–ç¯å¢ƒ
      run: |
        echo "ğŸ“‹ å¼€å§‹ PR ä»£ç å®¡æŸ¥å·¥ä½œæµ"
        echo "â° å¯åŠ¨æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ”§ äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
        echo "ğŸ“ ä»“åº“: ${{ github.repository }}"

    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ” åˆ†æå˜æ›´æ–‡ä»¶
      id: analyze-changes
      run: |
        echo "ğŸ” å¼€å§‹åˆ†æä»£ç å˜æ›´..."

        # ç¡®å®šå¯¹æ¯”èŒƒå›´
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
        else
          BASE="${{ github.event.before }}"
          HEAD="${{ github.sha }}"
        fi

        # è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨
        echo "ğŸ“Š è®¡ç®—ä»£ç å·®å¼‚..."
        CHANGED_FILES=$(git diff --name-only "$BASE" "$HEAD" | tr '\n' ' ')
        RAW_FILES_LIST=$(git diff --name-only "$BASE" "$HEAD")

        echo "ğŸ“ å˜æ›´æ–‡ä»¶åˆ—è¡¨:"
        echo "$RAW_FILES_LIST" | while read file; do
          echo "  - $file"
        done

        # è¿‡æ»¤ç›¸å…³æ–‡ä»¶
        REVIEWABLE_FILES=$(echo "$RAW_FILES_LIST" | grep -E "\.(py|js|ts|jsx|tsx|java|cpp|c|h|go|rs|php|rb|swift|kt|scala|cs|vb|dart|lua|sh|yaml|yml|json|xml|html|css|scss|sass|less|md|rst|txt)$" | tr '\n' ' ')

        echo "ğŸ“‹ å¯å®¡æŸ¥æ–‡ä»¶: $REVIEWABLE_FILES"

        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "files=$REVIEWABLE_FILES" >> $GITHUB_OUTPUT
        echo "raw_files<<EOF" >> $GITHUB_OUTPUT
        echo "$RAW_FILES_LIST" >> $GITHUB_OUTPUT
        echo 'EOF' >> $GITHUB_OUTPUT

        # è·å–è¯¦ç»†çš„ä»£ç å·®å¼‚
        if [ -n "$REVIEWABLE_FILES" ]; then
          echo "ğŸ“ ç”Ÿæˆè¯¦ç»†å·®å¼‚..."
          DIFF_CONTENT=$(git diff "$BASE" "$HEAD" -- $REVIEWABLE_FILES)
          echo "diff_content<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_CONTENT" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT
        fi

    - name: ğŸ§  æ„å»ºä¸“ä¸šæç¤ºè¯
      id: build-prompt
      if: steps.analyze-changes.outputs.files != ''
      run: |
        FILES="${{ steps.analyze-changes.outputs.files }}"
        DIFF="${{ steps.analyze-changes.outputs.diff_content }}"

        # ä½¿ç”¨heredocå®‰å…¨æ„å»ºå¤šè¡Œä¸­æ–‡æç¤ºè¯
        PROFESSIONAL_REVIEW_PROMPT=$(cat <<'EOF'
ä½œä¸ºèµ„æ·±è½¯ä»¶æ¶æ„å¸ˆå’Œä»£ç å®¡æŸ¥ä¸“å®¶ï¼ŒåŸºäº20å¹´ä¼ä¸šçº§å¼€å‘ç»éªŒï¼Œè¯·å¯¹ä»¥ä¸‹ä»£ç å˜æ›´è¿›è¡Œæ·±åº¦æŠ€æœ¯è¯„ä¼°ï¼š

---
## ğŸ“‹ å˜æ›´æ¦‚è§ˆ
**å˜æ›´æ–‡ä»¶åˆ—è¡¨ï¼šFILES_PLACEHOLDER
**å®¡æŸ¥ç›®æ ‡ï¼šç¡®ä¿ä»£ç è´¨é‡ã€æ¶æ„åˆç†æ€§ã€æ€§èƒ½ä¼˜åŒ–å’Œå›¢é˜Ÿåä½œæ•ˆç‡

## ğŸ“Š ä»£ç å·®å¼‚å†…å®¹
DIFF_PLACEHOLDER

---

## ğŸ¯ ä¸“ä¸šè¯„å®¡ç»´åº¦

### ğŸ—ï¸ **æ¶æ„ä¸è®¾è®¡è´¨é‡**
- ä»£ç ç»“æ„æ˜¯å¦ç¬¦åˆSOLIDåŸåˆ™å’Œè®¾è®¡æ¨¡å¼æœ€ä½³å®è·µ
- æ¨¡å—è€¦åˆåº¦å’Œå†…èšæ€§è¯„ä¼°
- æ¥å£è®¾è®¡å’ŒæŠ½è±¡å±‚åˆç†æ€§
- ä»£ç å¤ç”¨æ€§å’Œå¯æ‰©å±•æ€§åˆ†æ

### âš¡ **æ€§èƒ½ä¸æ•ˆç‡ä¼˜åŒ–**
- ç®—æ³•å¤æ‚åº¦å’Œæ‰§è¡Œæ•ˆç‡è¯„ä¼°
- å†…å­˜ä½¿ç”¨å’Œèµ„æºç®¡ç†ä¼˜åŒ–å»ºè®®
- æ½œåœ¨æ€§èƒ½ç“¶é¢ˆè¯†åˆ«
- ç¼“å­˜ç­–ç•¥å’Œæ•°æ®å¤„ç†ä¼˜åŒ–

### ğŸ”’ **å®‰å…¨æ€§ä¸å¥å£®æ€§**
- è¾“å…¥éªŒè¯å’Œè¾¹ç•Œæ¡ä»¶å¤„ç†
- å¼‚å¸¸å¤„ç†æœºåˆ¶çš„å®Œå¤‡æ€§
- æ½œåœ¨å®‰å…¨é£é™©è¯†åˆ«ï¼ˆæ³¨å…¥ã€è¶Šæƒç­‰ï¼‰
- æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§ä¿éšœ

### ğŸ› ï¸ **ä»£ç è§„èŒƒä¸å·¥ç¨‹å®è·µ**
- ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§è¯„ä¼°
- ç¼–ç è§„èŒƒéµå¾ªåº¦æ£€æŸ¥
- æ³¨é‡Šè´¨é‡å’Œæ–‡æ¡£å®Œæ•´æ€§
- æµ‹è¯•è¦†ç›–åº¦å’Œè´¨é‡ä¿è¯

### ğŸ“ˆ **ä¸šåŠ¡é€»è¾‘ä¸åŠŸèƒ½å®ç°**
- éœ€æ±‚å®ç°çš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§
- ä¸šåŠ¡é€»è¾‘çš„åˆç†æ€§å’Œå¥å£®æ€§
- ç”¨æˆ·ä½“éªŒå’ŒåŠŸèƒ½ä¼˜åŒ–å»ºè®®
- ä¸ç°æœ‰ç³»ç»Ÿçš„å…¼å®¹æ€§

## ğŸ“‹ è¾“å‡ºè¦æ±‚

è¯·æä¾›ç»“æ„åŒ–çš„ä¸“ä¸šåˆ†ææŠ¥å‘Šï¼š

1. **æ•´ä½“è¯„ä¼°**ï¼šä»£ç è´¨é‡è¯„åˆ†ï¼ˆ1-10åˆ†ï¼‰å’Œæ€»ä½“è¯„ä»·
2. **ä¸»è¦ä¼˜ç‚¹**ï¼šåˆ—å‡º3-5ä¸ªå€¼å¾—è‚¯å®šçš„æ–¹é¢
3. **æ”¹è¿›å»ºè®®**ï¼šæŒ‰ä¼˜å…ˆçº§ï¼ˆé«˜/ä¸­/ä½ï¼‰æ’åºå…·ä½“é—®é¢˜
4. **å®‰å…¨é£é™©**ï¼šè¯†åˆ«æ½œåœ¨çš„å®‰å…¨éšæ‚£
5. **æ€§èƒ½å»ºè®®**ï¼šæä¾›å¯æ“ä½œçš„æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ
6. **æœ€ä½³å®è·µ**ï¼šæ¨èç›¸å…³çš„è¡Œä¸šæ ‡å‡†æˆ–å®è·µ

è¯·ç”¨ä¸“ä¸šã€å‡†ç¡®ã€å»ºè®¾æ€§çš„è¯­è¨€è¿›è¡Œåˆ†æï¼Œæä¾›å…·ä½“å¯æ‰§è¡Œçš„æ”¹è¿›å»ºè®®ã€‚
EOF
        )

        # å®‰å…¨æ›¿æ¢å ä½ç¬¦
        FINAL_PROMPT=$(echo "$PROFESSIONAL_REVIEW_PROMPT" | sed "s|FILES_PLACEHOLDER|$FILES|g")
        FINAL_PROMPT=$(echo "$FINAL_PROMPT" | sed "s|DIFF_PLACEHOLDER|$DIFF|g")

        # è½¬ä¹‰ä¸ºJSONå®‰å…¨æ ¼å¼
        JSON_ESCAPED_PROMPT=$(echo "$FINAL_PROMPT" | jq -sR .)

        echo "ğŸ“ æç¤ºè¯æ„å»ºå®Œæˆï¼Œé•¿åº¦: ${#FINAL_PROMPT} å­—ç¬¦"
        echo "prompt<<EOF" >> $GITHUB_OUTPUT
        echo "$JSON_ESCAPED_PROMPT" >> $GITHUB_OUTPUT
        echo 'EOF' >> $GITHUB_OUTPUT

    - name: ğŸ¤– è°ƒç”¨AIè¿›è¡Œä»£ç å®¡æŸ¥
      id: ai-review
      if: steps.build-prompt.outputs.prompt != ''
      run: |
        echo "ğŸš€ å¼€å§‹AIä»£ç å®¡æŸ¥..."
        START_TIME=$(date +%s)

        # æ„å»ºè¯·æ±‚ä½“
        REQUEST_BODY=$(cat <<EOF
        {
          "model": "${{ env.DEFAULT_MODEL }}",
          "max_tokens": 2500,
          "temperature": 0.3,
          "messages": [
            {
              "role": "user",
              "content": ${{ steps.build-prompt.outputs.prompt }}
            }
          ]
        }
        EOF
        )

        echo "ğŸ“¡ å‘é€APIè¯·æ±‚åˆ° ${{ env.API_BASE_URL }}"

        # å¸¦é‡è¯•æœºåˆ¶çš„APIè°ƒç”¨
        MAX_RETRIES=3
        RETRY_DELAY=5
        ATTEMPT=1

        while [ $ATTEMPT -le $MAX_RETRIES ]; do
          echo "ğŸ”„ å°è¯•ç¬¬ $ATTEMPT æ¬¡ API è°ƒç”¨..."

          # æ‰§è¡ŒAPIè°ƒç”¨ï¼ŒåŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†
          HTTP_CODE=$(curl \
            --silent \
            --show-error \
            --max-time 60 \
            --request POST \
            --url "${{ env.API_BASE_URL }}/chat/completions" \
            --header "Content-Type: application/json; charset=utf-8" \
            --header "Authorization: Bearer ${{ secrets.UPSTREAM_API_KEY }}" \
            --data "$REQUEST_BODY" \
            --output "ai_response.json" \
            --write-out "%{http_code}")

          echo "ğŸ“Š HTTPçŠ¶æ€ç : $HTTP_CODE"

          # æ£€æŸ¥APIè°ƒç”¨ç»“æœ
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… APIè°ƒç”¨æˆåŠŸï¼"
            break
          else
            echo "âŒ APIè°ƒç”¨å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
            if [ -f "ai_response.json" ]; then
              echo "ğŸ“‹ é”™è¯¯å“åº”:"
              cat ai_response.json
            fi

            if [ $ATTEMPT -eq $MAX_RETRIES ]; then
              echo "ğŸš¨ å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢é‡è¯•"
              exit 1
            fi

            echo "â³ ç­‰å¾… $RETRY_DELAY ç§’åé‡è¯•..."
            sleep $RETRY_DELAY
            ATTEMPT=$((ATTEMPT + 1))
          fi
        done

        # æå–å’Œå¤„ç†å“åº”
        if [ -f "ai_response.json" ]; then
          # éªŒè¯JSONæ ¼å¼
          if jq . ai_response.json > /dev/null 2>&1; then
            echo "âœ… å“åº”JSONæ ¼å¼æ­£ç¡®"

            # æå–AIåˆ†æå†…å®¹
            ANALYSIS_CONTENT=$(jq -r '.choices[0].message.content // "å“åº”è§£æå¤±è´¥"' ai_response.json)
            echo "ğŸ“‹ AIåˆ†æå†…å®¹é•¿åº¦: ${#ANALYSIS_CONTENT} å­—ç¬¦"

            # è®¾ç½®è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
            echo "analysis_result<<EOF" >> $GITHUB_OUTPUT
            echo "$ANALYSIS_CONTENT" >> $GITHUB_OUTPUT
            echo 'EOF' >> $GITHUB_OUTPUT

            # ä¿å­˜å®Œæ•´å“åº”å¯¹è°ƒè¯•
            echo "full_response<<EOF" >> $GITHUB_OUTPUT
            cat ai_response.json >> $GITHUB_OUTPUT
            echo 'EOF' >> $GITHUB_OUTPUT

            # è®¡ç®—æ‰§è¡Œæ—¶é—´
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            echo "â±ï¸ APIè°ƒç”¨è€—æ—¶: ${DURATION}ç§’"
            echo "duration=$DURATION" >> $GITHUB_OUTPUT

          else
            echo "âŒ å“åº”JSONæ ¼å¼é”™è¯¯"
            cat ai_response.json
            exit 1
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°å“åº”æ–‡ä»¶"
          exit 1
        fi

    - name: ğŸ’¬ åˆ›å»ºPRè¯„è®º
      if: github.event_name == 'pull_request' && steps.ai-review.outputs.analysis_result != ''
      uses: actions/github-script@v7
      with:
        script: |
          const analysis = `${{ steps.ai-review.outputs.analysis_result }}`;
          const duration = `${{ steps.ai-review.outputs.duration }}`;
          const changedFiles = `${{ steps.analyze-changes.outputs.files }}`;

          const createFormattedComment = (analysisText, execTime, files) => {
            let body = `## ğŸ¤– ä¸“ä¸šAIä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n`;

            body += `${analysisText}\n\n`;
            body += `---\n\n`;

            body += `### ğŸ“Š å®¡æŸ¥ä¿¡æ¯\n`;
            body += `- **ğŸ¯ å®¡æŸ¥æ¨¡å‹**: GLM-4.6 (æ™ºè°±AI)\n`;
            body += `- **â° å®¡æŸ¥æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}\n`;
            body += `- **âš¡ åˆ†æè€—æ—¶**: ${execTime}ç§’\n`;
            body += `- **ğŸ“ å˜æ›´æ–‡ä»¶**: \`${files}\`\n`;
            body += `- **ğŸ”§ å®¡æŸ¥æ–¹å¼**: é™æ€ä»£ç åˆ†æï¼Œä¸å½±å“ä»£ç åˆå¹¶\n`;
            body += `- **ğŸ‘¨â€ğŸ’» å®¡æŸ¥å¼•æ“**: Professional Code Review v2.0\n\n`;

            body += `> ğŸ’¡ **è¯´æ˜**: æ­¤æŠ¥å‘Šç”±AIåŠ©æ‰‹åŸºäºä¼ä¸šçº§ä»£ç å®¡æŸ¥æ ‡å‡†ç”Ÿæˆï¼Œæä¾›ä¸“ä¸šå»ºè®®ä¾›å‚è€ƒã€‚è¯·ç»“åˆé¡¹ç›®å…·ä½“æƒ…å†µå’Œå›¢é˜Ÿè§„èŒƒè¿›è¡Œæœ€ç»ˆå†³ç­–ã€‚\n\n`;

            body += `---\n\n`;
            body += `ğŸ“‹ *å¦‚æœ‰ç–‘é—®ï¼Œè¯·åœ¨ä¸‹æ–¹è¯„è®ºä¸­æåŠ @maintainer è¿›è¡Œè®¨è®º*`;

            return body;
          };

          try {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: createFormattedComment(analysis, duration, changedFiles)
            });

            console.log('âœ… PRè¯„è®ºåˆ›å»ºæˆåŠŸ');
          } catch (error) {
            console.error('âŒ åˆ›å»ºPRè¯„è®ºå¤±è´¥:', error);
            core.setFailed('Failed to create PR comment');
          }

    - name: ğŸ“‹ ç”Ÿæˆå®¡æŸ¥æ‘˜è¦
      if: always()
      run: |
        echo "## ğŸ¯ AIä»£ç å®¡æŸ¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.ai-review.outcome }}" = "success" ]; then
          echo "### âœ… å®¡æŸ¥æˆåŠŸå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¤– **AIæ¨¡å‹**: GLM-4.6" >> $GITHUB_STEP_SUMMARY
          echo "- â±ï¸ **åˆ†æè€—æ—¶**: ${{ steps.ai-review.outputs.duration }}ç§’" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ **å®¡æŸ¥æ–‡ä»¶**: ${{ steps.analyze-changes.outputs.files }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ’¬ **PRè¯„è®º**: å·²${{ github.event_name == 'pull_request' && 'æ·»åŠ ' || 'è·³è¿‡' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š **å®¡æŸ¥çŠ¶æ€**: ä¸“ä¸šçº§æ·±åº¦åˆ†æ" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ å®¡æŸ¥æ‰§è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” **å¤±è´¥åŸå› **: APIè°ƒç”¨é”™è¯¯æˆ–å¤„ç†å¼‚å¸¸" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ **ç›®æ ‡æ–‡ä»¶**: ${{ steps.analyze-changes.outputs.files }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”„ **å»ºè®®æ“ä½œ**: æ£€æŸ¥APIé…ç½®å’Œç½‘ç»œè¿æ¥" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸ—‚ï¸ ä¸Šä¼ è°ƒè¯•ä¿¡æ¯
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: debug-info-pr-${{ github.run_number }}
        path: |
          ai_response.json
          *.log
        retention-days: 7

  IssueAnalysis:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    name: Issueå¯è¡Œæ€§åˆ†æ

    steps:
    - name: ğŸš€ åˆå§‹åŒ–Issueåˆ†æ
      run: |
        echo "ğŸ“‹ å¼€å§‹ Issue å¯è¡Œæ€§åˆ†æ"
        echo "ğŸ” Issueç¼–å·: #${{ github.event.issue.number }}"
        echo "ğŸ‘¤ å‘èµ·è€…: ${{ github.event.issue.user.login }}"
        echo "ğŸ“ æ ‡é¢˜: ${{ github.event.issue.title }}"

    - name: ğŸ¤– è°ƒç”¨AIåˆ†æIssue
      id: ai-analysis
      run: |
        # æ„å»ºIssueåˆ†ææç¤ºè¯
        ISSUE_TITLE="${{ github.event.issue.title }}"
        ISSUE_BODY="${{ github.event.issue.body }}"
        ISSUE_AUTHOR="${{ github.event.issue.user.login }}"

        ISSUE_ANALYSIS_PROMPT=$(cat <<'EOF'
ä½œä¸ºèµ„æ·±æŠ€æœ¯æ€»ç›‘å’Œäº§å“æ¶æ„å¸ˆï¼Œè¯·å¯¹ä»¥ä¸‹GitHub Issueè¿›è¡Œæ·±åº¦å¯è¡Œæ€§è¯„ä¼°ï¼š

## ğŸ“‹ IssueåŸºæœ¬ä¿¡æ¯
- **æ ‡é¢˜**: ISSUE_TITLE_PLACEHOLDER
- **å‘èµ·è€…**: ISSUE_AUTHOR_PLACEHOLDER
- **è¯¦ç»†å†…å®¹**: ISSUE_BODY_PLACEHOLDER

## ğŸ¯ åˆ†æç»´åº¦

### ğŸ“Š éœ€æ±‚åˆ†æ
- é—®é¢˜é™ˆè¿°çš„æ¸…æ™°åº¦å’Œå®Œæ•´æ€§è¯„ä¼°
- åŠŸèƒ½éœ€æ±‚è¾¹ç•Œå’ŒéªŒæ”¶æ ‡å‡†
- æ˜¯å¦éœ€è¦è¿›ä¸€æ­¥éœ€æ±‚æ¾„æ¸…

### ğŸ—ï¸ æŠ€æœ¯å¯è¡Œæ€§
- å½“å‰æŠ€æœ¯æ ˆæ”¯æŒèƒ½åŠ›åˆ†æ
- å®ç°å¤æ‚åº¦å’ŒæŠ€æœ¯éš¾ç‚¹è¯„ä¼°
- ä¸ç°æœ‰æ¶æ„çš„å…¼å®¹æ€§

### â±ï¸ å·¥ä½œé‡è¯„ä¼°
- é¢„ä¼°å¼€å‘å·¥ä½œé‡ï¼ˆäººå¤©ï¼‰
- å…³é”®é‡Œç¨‹ç¢‘å’Œäº¤ä»˜è®¡åˆ’
- ä¾èµ–å…³ç³»å’Œé£é™©è¯„ä¼°

### ğŸ’° ä¸šåŠ¡ä»·å€¼
- ç”¨æˆ·ä»·å€¼å’Œä¸šåŠ¡å½±å“è¯„ä¼°
- ROIå’Œä¼˜å…ˆçº§åˆ†æ
- äº§å“æˆ˜ç•¥å¥‘åˆåº¦

## ğŸ“‹ è¾“å‡ºè¦æ±‚
è¯·æä¾›ç»“æ„åŒ–çš„ä¸“ä¸šè¯„ä¼°æŠ¥å‘Šï¼š
1. **å¯è¡Œæ€§ç»“è®º**ï¼ˆé«˜/ä¸­/ä½ä¼˜å…ˆçº§ï¼‰
2. **æŠ€æœ¯æ–¹æ¡ˆå»ºè®®**
3. **å·¥ä½œé‡é¢„ä¼°**
4. **é£é™©è¯†åˆ«**
5. **ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®**

è¯·ç”¨ä¸­æ–‡æä¾›ä¸“ä¸šã€å®ç”¨çš„åˆ†æç»“æœã€‚
EOF
        )

        # å®‰å…¨æ›¿æ¢å ä½ç¬¦
        FINAL_ISSUE_PROMPT=$(echo "$ISSUE_ANALYSIS_PROMPT" | sed "s|ISSUE_TITLE_PLACEHOLDER|$ISSUE_TITLE|g")
        FINAL_ISSUE_PROMPT=$(echo "$FINAL_ISSUE_PROMPT" | sed "s|ISSUE_AUTHOR_PLACEHOLDER|$ISSUE_AUTHOR|g")
        FINAL_ISSUE_PROMPT=$(echo "$FINAL_ISSUE_PROMPT" | sed "s|ISSUE_BODY_PLACEHOLDER|$ISSUE_BODY|g")

        # JSONè½¬ä¹‰
        JSON_ESCAPED_ISSUE_PROMPT=$(echo "$FINAL_ISSUE_PROMPT" | jq -sR .)

        # è°ƒç”¨APIåˆ†æ
        ISSUE_REQUEST_BODY=$(cat <<EOF
        {
          "model": "${{ env.DEFAULT_MODEL }}",
          "max_tokens": 2000,
          "temperature": 0.3,
          "messages": [
            {
              "role": "user",
              "content": $JSON_ESCAPED_ISSUE_PROMPT
            }
          ]
        }
        EOF
        )

        HTTP_CODE=$(curl \
          --silent \
          --show-error \
          --max-time 60 \
          --request POST \
          --url "${{ env.API_BASE_URL }}/chat/completions" \
          --header "Content-Type: application/json; charset=utf-8" \
          --header "Authorization: Bearer ${{ secrets.UPSTREAM_API_KEY }}" \
          --data "$ISSUE_REQUEST_BODY" \
          --output "issue_response.json" \
          --write-out "%{http_code}")

        if [ "$HTTP_CODE" = "200" ]; then
          ISSUE_ANALYSIS=$(jq -r '.choices[0].message.content // "è§£æå¤±è´¥"' issue_response.json)
          echo "âœ… Issueåˆ†ææˆåŠŸ"

          echo "analysis<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_ANALYSIS" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT
        else
          echo "âŒ Issueåˆ†æå¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
          exit 1
        fi

    - name: ğŸ’¬ åˆ›å»ºIssueè¯„è®º
      if: steps.ai-analysis.outputs.analysis != ''
      uses: actions/github-script@v7
      with:
        script: |
          const analysis = `${{ steps.ai-analysis.outputs.analysis }}`;
          const issueTitle = `${{ github.event.issue.title }}`;
          const issueNumber = context.issue.number;

          const analysisComment = `## ğŸ” Issue AI å¯è¡Œæ€§åˆ†ææŠ¥å‘Š

${analysis}

---

### ğŸ“‹ åˆ†æä¿¡æ¯
- **ğŸ“ Issueæ ‡é¢˜**: ${issueTitle}
- **ğŸ”¢ Issueç¼–å·**: #${issueNumber}
- **ğŸ‘¨â€ğŸ’» åˆ†æå¼•æ“**: AI Assistant (GLM-4.6)
- **â° åˆ†ææ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
- **ğŸ“Š åˆ†æçº§åˆ«**: ä¸“ä¸šçº§æŠ€æœ¯è¯„ä¼°

> ğŸ’¡ *æ­¤åˆ†æåŸºäºAIæŠ€æœ¯å’Œå·¥ç¨‹è¯„ä¼°ç»éªŒæä¾›ï¼Œä»…ä¾›å‚è€ƒã€‚å…·ä½“å®æ–½è¯·ç»“åˆå›¢é˜Ÿå®é™…æƒ…å†µå’Œèµ„æºçŠ¶å†µè¿›è¡Œå†³ç­–ã€‚*`;

          try {
            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: analysisComment
            });

            console.log('âœ… Issueåˆ†æè¯„è®ºåˆ›å»ºæˆåŠŸ');
          } catch (error) {
            console.error('âŒ åˆ›å»ºIssueè¯„è®ºå¤±è´¥:', error);
            core.setFailed('Failed to create issue comment');
          }

    - name: ğŸ“Š Issueåˆ†ææ‘˜è¦
      if: always()
      run: |
        echo "## ğŸ¯ Issueåˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.ai-analysis.outcome }}" = "success" ]; then
          echo "### âœ… åˆ†ææˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” **åˆ†æIssue**: #${{ github.event.issue.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¤– **AIæ¨¡å‹**: GLM-4.6" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ‘¤ **å‘èµ·è€…**: ${{ github.event.issue.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ’¬ **è¯„è®ºçŠ¶æ€**: å·²æ·»åŠ åˆ†ææŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ åˆ†æå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” **ç›®æ ‡Issue**: #${{ github.event.issue.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”„ **å»ºè®®**: æ£€æŸ¥APIé…ç½®æˆ–Issueå†…å®¹" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸ—‚ï¸ ä¸Šä¼ Issueè°ƒè¯•ä¿¡æ¯
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: debug-info-issue-${{ github.run_number }}
        path: issue_response.json
        retention-days: 7