<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API转换器配置</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .model-mapping {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .model-mapping-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .model-mapping h3 {
            color: #333;
            font-size: 1.1rem;
        }

        .remove-mapping {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .remove-mapping:hover {
            background: #dc2626;
        }

        .mapping-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 30px;
        }

        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>API转换器配置</h1>
            <p>配置OpenAI API和模型映射关系</p>
        </div>

        <div class="content">
            <div class="status" id="status"></div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('basic')">基础配置</button>
                <button class="tab" onclick="switchTab('models')">模型映射</button>
            </div>

            <div id="basic-tab" class="tab-content active">
                <div class="section">
                    <h2>OpenAI API 配置</h2>
                    <div class="form-group">
                        <label for="openai-url">OpenAI API URL:</label>
                        <input type="text" id="openai-url" placeholder="https://api.openai.com/v1" value="https://apis.iflow.cn/v1">
                    </div>
                    <div class="form-group">
                        <label for="openai-key">OpenAI API Key:</label>
                        <input type="password" id="openai-key" placeholder="sk-..." value="sk-3b7873164cc06ed48ebd1816ad8874df">
                    </div>
                    <div class="form-group">
                        <label for="server-port">服务器端口:</label>
                        <input type="number" id="server-port" placeholder="8080" value="8080">
                    </div>
                    <div class="form-group">
                        <label for="test-model">测试模型:</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="test-model" style="flex: 1;">
                                <option value="">请先测试连接获取模型列表</option>
                            </select>
                            <input type="text" id="custom-model" placeholder="或手动输入模型名" style="flex: 1;">
                        </div>
                    </div>
                </div>
            </div>

            <div id="models-tab" class="tab-content">
                <div class="section">
                    <h2>模型映射配置</h2>
                    <div id="model-mappings">
                        <!-- 模型映射将在这里动态生成 -->
                    </div>
                    <button class="btn btn-secondary" onclick="addModelMapping()">添加模型映射</button>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="saveConfig()">保存配置</button>
                <button class="btn btn-success" onclick="testConnection()">测试连接</button>
                <button class="btn btn-secondary" onclick="resetConfig()">重置配置</button>
            </div>
        </div>
    </div>

    <script>
        // 默认模型映射
        const defaultModelMappings = [
            { anthropic: 'claude-3-opus-20240229', openai: 'glm-4.5' },
            { anthropic: 'claude-3-sonnet-20240229', openai: 'glm-4.6' },
            { anthropic: 'claude-3-haiku-20240307', openai: 'gpt-3.5-turbo' },
            { anthropic: 'claude-3-5-sonnet-20241022', openai: 'gpt-4o' }
        ];

        let modelMappings = [];

        // 初始化
        function init() {
            loadConfig();
            renderModelMappings();
            loadAvailableModels();
        }

        // 切换标签页
        function switchTab(tabName) {
            // 移除所有活动状态
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 添加活动状态
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // 加载配置
        async function loadConfig() {
            try {
                const response = await fetch('/config');
                if (response.ok) {
                    const config = await response.json();
                    document.getElementById('openai-url').value = config.openai?.base_url || '';
                    document.getElementById('openai-key').value = config.openai?.api_key || '';
                    document.getElementById('server-port').value = config.server?.port || '8080';
                    modelMappings = config.model_mappings || [...defaultModelMappings];
                } else {
                    // 如果无法从服务器加载，使用localStorage作为备选
                    const savedConfig = localStorage.getItem('apiConverterConfig');
                    if (savedConfig) {
                        const config = JSON.parse(savedConfig);
                        document.getElementById('openai-url').value = config.openaiUrl || '';
                        document.getElementById('openai-key').value = config.openaiKey || '';
                        document.getElementById('server-port').value = config.serverPort || '8080';
                        modelMappings = config.modelMappings || [...defaultModelMappings];
                    } else {
                        modelMappings = [...defaultModelMappings];
                    }
                }
            } catch (error) {
                console.error('加载配置失败:', error);
                modelMappings = [...defaultModelMappings];
            }
        }

        // 保存配置
        async function saveConfig() {
            const config = {
                openai: {
                    base_url: document.getElementById('openai-url').value,
                    api_key: document.getElementById('openai-key').value
                },
                server: {
                    port: parseInt(document.getElementById('server-port').value),
                    host: '0.0.0.0',
                    debug: true
                },
                model_mappings: modelMappings
            };
            
            try {
                const response = await fetch('/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    showStatus('配置已保存到服务器！', 'success');
                } else {
                    const error = await response.json();
                    showStatus(`保存失败：${error.message}`, 'error');
                }
            } catch (error) {
                showStatus(`保存失败：${error.message}`, 'error');
            }
        }

        // 重置配置
        async function resetConfig() {
            if (confirm('确定要重置所有配置吗？')) {
                try {
                    const response = await fetch('/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            openai: {
                                base_url: 'https://apis.iflow.cn/v1',
                                api_key: 'sk-3b7873164cc06ed48ebd1816ad8874df'
                            },
                            server: {
                                port: 8080,
                                host: '0.0.0.0',
                                debug: true
                            },
                            model_mappings: [...defaultModelMappings]
                        })
                    });

                    if (response.ok) {
                        document.getElementById('openai-url').value = 'https://apis.iflow.cn/v1';
                        document.getElementById('openai-key').value = 'sk-3b7873164cc06ed48ebd1816ad8874df';
                        document.getElementById('server-port').value = '8080';
                        modelMappings = [...defaultModelMappings];
                        renderModelMappings();
                        showStatus('配置已重置！', 'success');
                    } else {
                        const error = await response.json();
                        showStatus(`重置失败：${error.message}`, 'error');
                    }
                } catch (error) {
                    showStatus(`重置失败：${error.message}`, 'error');
                }
            }
        }

        // 测试连接
        async function testConnection() {
            const url = document.getElementById('openai-url').value;
            const key = document.getElementById('openai-key').value;
            const testModel = document.getElementById('test-model').value;
            const customModel = document.getElementById('custom-model').value;
            
            if (!url || !key) {
                showStatus('请先填写API URL和密钥！', 'error');
                return;
            }

            // 优先使用下拉框选择的模型，如果没有则使用手动输入的模型
            const finalTestModel = testModel || customModel;

            try {
                // 使用代理方式测试连接，避免CORS问题
                const response = await fetch('/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        key: key,
                        model: finalTestModel
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showStatus(result.message || '连接测试成功！', 'success');
                    
                    // 如果返回了可用模型列表，更新下拉框
                    if (result.available_models && result.available_models.length > 0) {
                        updateModelDropdown(result.available_models);
                    }
                } else {
                    showStatus(`连接测试失败：${result.error || result.message}`, 'error');
                }
            } catch (error) {
                showStatus(`连接测试失败：${error.message}`, 'error');
            }
        }

        // 加载可用模型列表
        function loadAvailableModels() {
            // 直接显示默认模型，不尝试获取API模型列表
            // 因为很多厂家不提供获取模型列表的端点
            updateModelDropdown([]);
        }

        // 更新模型下拉框
        function updateModelDropdown(models) {
            const select = document.getElementById('test-model');
            select.innerHTML = '<option value="">请选择模型</option>';
            
            // 添加从API获取的模型
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                select.appendChild(option);
            });
            
            // 添加默认模型（如果不在列表中）
            const defaultModels = ['claude-3-sonnet-20240229', 'claude-3-opus-20240229', 'claude-3-haiku-20240307', 'claude-3-5-sonnet-20241022'];
            defaultModels.forEach(model => {
                if (!models.includes(model)) {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    select.appendChild(option);
                }
            });
        }

        // 渲染模型映射
        function renderModelMappings() {
            const container = document.getElementById('model-mappings');
            container.innerHTML = '';
            
            modelMappings.forEach((mapping, index) => {
                const mappingDiv = document.createElement('div');
                mappingDiv.className = 'model-mapping';
                mappingDiv.innerHTML = `
                    <div class="model-mapping-header">
                        <h3>模型映射 ${index + 1}</h3>
                        <button class="remove-mapping" onclick="removeModelMapping(${index})">删除</button>
                    </div>
                    <div class="mapping-row">
                        <div class="form-group">
                            <label>Anthropic 模型:</label>
                            <input type="text" value="${mapping.anthropic}" onchange="updateMapping(${index}, 'anthropic', this.value)">
                        </div>
                        <div class="form-group">
                            <label>OpenAI 模型:</label>
                            <input type="text" value="${mapping.openai}" onchange="updateMapping(${index}, 'openai', this.value)">
                        </div>
                    </div>
                `;
                container.appendChild(mappingDiv);
            });
        }

        // 添加模型映射
        function addModelMapping() {
            modelMappings.push({ anthropic: '', openai: '' });
            renderModelMappings();
        }

        // 删除模型映射
        function removeModelMapping(index) {
            modelMappings.splice(index, 1);
            renderModelMappings();
        }

        // 更新映射
        function updateMapping(index, field, value) {
            modelMappings[index][field] = value;
        }

        // 显示状态
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
