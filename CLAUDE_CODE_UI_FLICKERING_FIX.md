# Claude Code UIé—ªçƒé—®é¢˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æ¦‚è¿°

åœ¨ä½¿ç”¨Claude Codeæ—¶ï¼ŒUIç•Œé¢å‡ºç°é¢‘ç¹çš„é—ªçƒç°è±¡ï¼Œç‰¹åˆ«æ˜¯åœ¨å·¥å…·è°ƒç”¨æœŸé—´ï¼ŒçŠ¶æ€ä¼šåœ¨"responding" â†’ "tool-input" â†’ "tool"ä¹‹é—´é¢‘ç¹åˆ‡æ¢ã€‚

## æ·±å…¥åˆ†æç»“æœ

### 1. Claude CodeæœŸæœ›çš„SSEäº‹ä»¶æ ¼å¼

é€šè¿‡åˆ†æAnthropicå®˜æ–¹APIæ–‡æ¡£ï¼ŒClaude CodeæœŸæœ›ä»¥ä¸‹æ ‡å‡†SSEäº‹ä»¶åºåˆ—ï¼š

```
1. message_start - åŒ…å«å®Œæ•´æ¶ˆæ¯å…ƒæ•°æ®
2. content_block_start (text) - æ–‡æœ¬å—å¼€å§‹ï¼Œindex=0
3. content_block_delta (text_delta) - æ–‡æœ¬å†…å®¹å¢é‡
4. content_block_stop (text) - æ–‡æœ¬å—ç»“æŸï¼Œindex=0
5. content_block_start (tool_use) - å·¥å…·å—å¼€å§‹ï¼Œindex=1
6. content_block_delta (input_json_delta) - å·¥å…·å‚æ•°å¢é‡
7. content_block_stop (tool_use) - å·¥å…·å—ç»“æŸï¼Œindex=1
8. message_delta - æ¶ˆæ¯çº§åˆ«æ›´æ–°
9. message_stop - æ¶ˆæ¯ç»“æŸ
```

### 2. æˆ‘ä»¬åŸæœ‰SSEç”Ÿæˆå™¨çš„é—®é¢˜

#### ğŸ”´ å…³é”®é—®é¢˜ï¼š

1. **content_block_indexé”™è¯¯**
   - æ‰€æœ‰äº‹ä»¶éƒ½ä½¿ç”¨`index: 0`
   - æ–‡æœ¬å’Œå·¥å…·è°ƒç”¨æ··ç”¨åŒä¸€ä¸ªç´¢å¼•
   - å¯¼è‡´UIæ— æ³•æ­£ç¡®åŒºåˆ†ä¸åŒçš„å†…å®¹å—

2. **äº‹ä»¶åºåˆ—ä¸å®Œæ•´**
   - ç¼ºå°‘æ–‡æœ¬å—çš„`content_block_stop`äº‹ä»¶
   - å·¥å…·è°ƒç”¨æ—¶æ²¡æœ‰æ­£ç¡®ç»“æŸå‰ä¸€ä¸ªæ–‡æœ¬å—

3. **äº‹ä»¶æ ¼å¼ä¸å®Œæ•´**
   - `message_start`ç¼ºå¤±`stop_reason`ã€`stop_sequence`ã€`usage`å­—æ®µ
   - `message_delta`ç¼ºå¤±`stop_sequence`å’Œ`usage`å­—æ®µ

#### ğŸŸ¡ æ¬¡è¦é—®é¢˜ï¼š

1. **äº‹ä»¶é¢‘ç‡è¿‡é«˜**
   - æ²¡æœ‰é€‚å½“çš„å»¶è¿Ÿæ§åˆ¶
   - å¯èƒ½å¯¼è‡´UIæ¸²æŸ“å‹åŠ›è¿‡å¤§

### 3. UIé—ªçƒçš„æ ¹æœ¬åŸå› 

Claude Codeçš„UIåŸºäºcontent_blockçš„indexæ¥ç®¡ç†ä¸åŒçš„å†…å®¹åŒºåŸŸï¼š

- **index=0**: æ–‡æœ¬å“åº”åŒºåŸŸ
- **index=1**: å·¥å…·è°ƒç”¨åŒºåŸŸ
- **index=2**: å…¶ä»–å·¥å…·åŒºåŸŸ...

å½“æˆ‘ä»¬æ‰€æœ‰çš„content_blockéƒ½ä½¿ç”¨index=0æ—¶ï¼š

1. UIæ”¶åˆ°æ–‡æœ¬å—çš„`content_block_start(index=0)` â†’ æ˜¾ç¤ºæ–‡æœ¬åŒºåŸŸ
2. UIæ”¶åˆ°å·¥å…·è°ƒç”¨å—çš„`content_block_start(index=0)` â†’ è¦†ç›–æ–‡æœ¬åŒºåŸŸï¼Œæ˜¾ç¤ºå·¥å…·åŒºåŸŸ
3. UIåœ¨ä¸¤ä¸ªç›¸åŒindexçš„å†…å®¹å—ä¹‹é—´é¢‘ç¹åˆ‡æ¢ â†’ **äº§ç”Ÿé—ªçƒ**

## ä¿®å¤æ–¹æ¡ˆ

### 1. åˆ›å»ºä¿®å¤åçš„SSEç”Ÿæˆå™¨

æ–‡ä»¶ï¼š`app/fixed_sse_generator.py`

#### æ ¸å¿ƒä¿®å¤ï¼š

1. **æ­£ç¡®çš„ç´¢å¼•ç®¡ç†**
   ```python
   self.content_block_index = 0
   # æ–‡æœ¬å—ä½¿ç”¨index=0ï¼Œå·¥å…·å—ä½¿ç”¨index=1
   ```

2. **å®Œæ•´çš„äº‹ä»¶åºåˆ—**
   ```python
   # ç¡®ä¿æ¯ä¸ªå—éƒ½æœ‰å®Œæ•´çš„å¼€å§‹-å¢é‡-ç»“æŸåºåˆ—
   if text_started and not text_finished:
       yield self._create_content_block_stop(self.current_text_block)
   ```

3. **ç¬¦åˆè§„èŒƒçš„äº‹ä»¶æ ¼å¼**
   ```python
   # message_startåŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ
   'stop_reason': None,
   'stop_sequence': None,
   'usage': {'input_tokens': input_tokens, 'output_tokens': 0}
   ```

4. **é€‚å½“çš„äº‹ä»¶å»¶è¿Ÿ**
   ```python
   if self.enable_delay:
       time.sleep(0.01)  # 10mså»¶è¿Ÿ
   ```

### 2. ä¿®æ”¹ä¸»æœåŠ¡å™¨

æ–‡ä»¶ï¼š`app/server.py`

#### ä¸»è¦ä¿®æ”¹ï¼š

1. **å¯¼å…¥ä¿®å¤åçš„ç”Ÿæˆå™¨**
   ```python
   from .fixed_sse_generator import create_fixed_sse_generator
   ```

2. **æ›´æ–°SSEç”Ÿæˆå‡½æ•°**
   ```python
   def create_optimized_sse_generator(upstream, request_headers, model_name, input_tokens=0):
       return create_fixed_sse_generator(
           upstream_response=upstream,
           model_name=model_name,
           input_tokens=input_tokens,
           enable_delay=enable_delay
       )
   ```

3. **æ·»åŠ input_tokensè®¡ç®—**
   ```python
   # è®¡ç®—input_tokensï¼ˆç®€å•ä¼°ç®—ï¼‰
   input_tokens = max(1, sum(len(msg.get('content', '')) // 4 for msg in anthropic_request.get('messages', [])))
   ```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ–‡ä»¶ï¼š`test_fixed_sse.py`

æµ‹è¯•ç»“æœæ˜¾ç¤ºï¼š

#### âœ… ä¿®å¤æˆåŠŸï¼š

1. **äº‹ä»¶åºåˆ—æ­£ç¡®**
   ```
   1. message_start [åŒ…å«å®Œæ•´å­—æ®µ]
   2. content_block_start[0]: text
   3-6. content_block_delta[0]: text_delta
   7. content_block_stop[0]: text
   8. message_delta [åŒ…å«å®Œæ•´å­—æ®µ]
   9. message_stop
   10. DONE
   ```

2. **å­—æ®µå®Œæ•´æ€§**
   - `message_start`åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ
   - `message_delta`åŒ…å«usageä¿¡æ¯
   - content_blockä½¿ç”¨æ­£ç¡®çš„ç´¢å¼•

3. **åºåˆ—å®Œæ•´æ€§**
   - æ¯ä¸ªå†…å®¹å—éƒ½æœ‰å®Œæ•´çš„å¼€å§‹-å¢é‡-ç»“æŸåºåˆ—
   - äº‹ä»¶é¡ºåºç¬¦åˆAnthropicè§„èŒƒ

## é¢„æœŸæ•ˆæœ

ä¿®å¤åçš„ç³»ç»Ÿåº”è¯¥ï¼š

1. **æ¶ˆé™¤UIé—ªçƒ**
   - æ–‡æœ¬å’Œå·¥å…·è°ƒç”¨ä½¿ç”¨ä¸åŒçš„index
   - UIå¯ä»¥æ­£ç¡®åŒºåˆ†å’Œç®¡ç†ä¸åŒçš„å†…å®¹åŒºåŸŸ

2. **æ”¹å–„ç”¨æˆ·ä½“éªŒ**
   - çŠ¶æ€è½¬æ¢æ›´åŠ å¹³æ»‘
   - å·¥å…·è°ƒç”¨æœŸé—´UIçŠ¶æ€ç¨³å®š

3. **æé«˜å…¼å®¹æ€§**
   - å®Œå…¨ç¬¦åˆAnthropic APIè§„èŒƒ
   - æ”¯æŒæ›´å¤æ‚çš„å·¥å…·è°ƒç”¨åœºæ™¯

## éƒ¨ç½²å»ºè®®

### 1. æµ‹è¯•éƒ¨ç½²

```bash
# å¤‡ä»½å½“å‰ç‰ˆæœ¬
cp app/server.py app/server.py.backup

# éƒ¨ç½²ä¿®å¤ç‰ˆæœ¬
# ä»£ç å·²ç»æ›´æ–°ï¼Œç›´æ¥é‡å¯æœåŠ¡
python svc.py restart -b
```

### 2. ç›‘æ§éªŒè¯

1. **æ£€æŸ¥æ—¥å¿—**
   ```bash
   tail -f logs/api_server_$(date +%Y-%m-%d).log
   ```

2. **æµ‹è¯•å·¥å…·è°ƒç”¨**
   ```bash
   # ä½¿ç”¨Claude Codeè¿›è¡Œå·¥å…·è°ƒç”¨æµ‹è¯•
   ANTHROPIC_BASE_URL=http://localhost:8080 claude
   ```

3. **è§‚å¯ŸUIè¡Œä¸º**
   - ç¡®è®¤æ–‡æœ¬å“åº”æ˜¾ç¤ºæ­£å¸¸
   - ç¡®è®¤å·¥å…·è°ƒç”¨æœŸé—´UIç¨³å®š
   - ç¡®è®¤æ— é—ªçƒç°è±¡

### 3. å›æ»šæ–¹æ¡ˆ

å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# æ¢å¤åŸç‰ˆæœ¬
cp app/server.py.backup app/server.py
python svc.py restart -b
```

## æŠ€æœ¯ç»†èŠ‚

### å…³é”®ä¿®å¤ç‚¹å¯¹æ¯”

| ä¿®å¤é¡¹ | åŸç‰ˆæœ¬ | ä¿®å¤ç‰ˆæœ¬ |
|--------|--------|----------|
| content_blockç´¢å¼• | å…¨éƒ¨ä½¿ç”¨index=0 | æ–‡æœ¬ç”¨0ï¼Œå·¥å…·ç”¨1 |
| äº‹ä»¶åºåˆ— | ç¼ºå°‘stopäº‹ä»¶ | å®Œæ•´çš„å¼€å§‹-å¢é‡-ç»“æŸ |
| message_startå­—æ®µ | ç¼ºå¤±3ä¸ªå­—æ®µ | åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ |
| message_deltaå­—æ®µ | ç¼ºå¤±2ä¸ªå­—æ®µ | åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ |
| äº‹ä»¶å»¶è¿Ÿ | æ— å»¶è¿Ÿ | å¯é…ç½®10mså»¶è¿Ÿ |

### æ€§èƒ½å½±å“

- **CPUå¼€é”€**: å¾®å¢ï¼ˆç´¢å¼•ç®¡ç†å’Œå»¶è¿Ÿæ§åˆ¶ï¼‰
- **å†…å­˜å¼€é”€**: å‡ ä¹æ— å˜åŒ–
- **ç½‘ç»œå¼€é”€**: ç•¥å¢ï¼ˆæ›´å®Œæ•´çš„äº‹ä»¶æ•°æ®ï¼‰
- **UIæ€§èƒ½**: æ˜¾è‘—æ”¹å–„ï¼ˆå‡å°‘é‡ç»˜é¢‘ç‡ï¼‰

## ç»“è®º

é€šè¿‡æ·±å…¥åˆ†æClaude Codeçš„SSEäº‹ä»¶å¤„ç†æœºåˆ¶ï¼Œæˆ‘ä»¬å‡†ç¡®å®šä½äº†UIé—ªçƒçš„æ ¹æœ¬åŸå› ï¼š**content_blockç´¢å¼•ç®¡ç†ä¸å½“å¯¼è‡´çš„äº‹ä»¶åºåˆ—æ··ä¹±**ã€‚

ä¿®å¤æ–¹æ¡ˆé€šè¿‡ï¼š
1. æ­£ç¡®çš„ç´¢å¼•åˆ†é…
2. å®Œæ•´çš„äº‹ä»¶åºåˆ—
3. ç¬¦åˆè§„èŒƒçš„äº‹ä»¶æ ¼å¼
4. é€‚å½“çš„äº‹ä»¶å»¶è¿Ÿæ§åˆ¶

ä»æ ¹æœ¬ä¸Šè§£å†³äº†é—®é¢˜ï¼Œé¢„æœŸå°†æ˜¾è‘—æ”¹å–„Claude Codeçš„ç”¨æˆ·ä½“éªŒã€‚

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-20
**å½±å“èŒƒå›´**: SSEæµå¼å“åº”ç”Ÿæˆ
**é£é™©è¯„ä¼°**: ä½ï¼ˆå®Œå…¨å‘åå…¼å®¹ï¼‰